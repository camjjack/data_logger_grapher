<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Data Logger Grapher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="node_modules/materialize-css/dist/css/materialize.min.css" rel="stylesheet">
    <!-- Latest compiled and minified plotly.js JavaScript -->
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="node_modules/hammerjs/hammer.min.js"></script>
    <script type="text/javascript" src="node_modules/materialize-css/dist/js/materialize.min.js"></script>
    <script type="text/javascript">
    const electron = require('electron');
    var fs = require('fs');
    var csv = require('fast-csv');
    const remote = electron.remote;
    const dialog = electron.remote.dialog;
    const Menu = remote.Menu;
    const MenuItem = remote.MenuItem;
    const pivot = 3.0;

    var graph_data = {};
    var first_name = '';
    var second_name = '';

    var getAverageFromArray = function(a) {
        var sum = 0;
        for( var i = 0; i < a.length; i++ ){
            sum += parseInt( a[i], 10 );
        }
        return sum/a.length;
    }
    var getTable = function(name) {
        var data_dict = graph_data[name];
        var s = "<table class='striped'><thead><tr><th data-field='item' colspan='2'>" + name + "</th></tr></thead><tbody>";
        s += "<tr><th>Sample time</th><td>" + data_dict.sampleTime / 60000 + " minutes</td></tr>";
        s += "<tr><th>% time spent cooling</th><td>" + ((data_dict.cooling / data_dict.sampleTime) * 100).toFixed(2) + "</td></tr>";
        s += "<tr><th>% time above " + pivot + "&deg;C</th><td>" + ((data_dict.timeAbove / data_dict.sampleTime) * 100).toFixed(2) + "%</td></tr>";
        s += "<tr><th>% time below " + pivot + "&deg;C</th><td>" + ((data_dict.timeBelow / data_dict.sampleTime) * 100).toFixed(2) + "%</td></tr>";
        s += "<tr><th>Humidity average</th><td>" + getAverageFromArray(data_dict.humidity).toFixed(2) + "</td></tr>";
        s += "<tr><th>Dew point average</th><td>" + getAverageFromArray(data_dict.dew_point).toFixed(2) + "&deg;C</td></tr>";
        s += "</tbody></table>";
        return s;
    }
    var processFile = function(file, name, graphDivName, tableDiv) {
        var data_dict = {};
        data_dict.x_data = [];
        data_dict.y_data = [];
        data_dict.humidity = [];
        data_dict.dew_point = [];
        data_dict.cooling = 0;
        data_dict.timeAbove = 0;
        data_dict.timeBelow = 0;
        data_dict.coolingSince = 0;

        csv
         .fromPath(file, {headers : ["index", "time", "celsius", "humidity","dew_point", ,], ignoreEmpty: true})
            .on("data", function(data){
                if(data.celsius < 10.0) {
                    if( data_dict.x_data.length > 0) {
                            if( data_dict.coolingSince > 0 && data.celsius >= data_dict.y_data[data_dict.y_data.length-1]) {
                                //stopped cooling at the last poll
                                data_dict.cooling += new Date(data_dict.x_data[data_dict.x_data.length-1]) -data_dict.coolingSince;
                                data_dict.coolingSince = 0;
                            }
                            if( data_dict.coolingSince == 0 && data.celsius < data_dict.y_data[data_dict.y_data.length-1]) {
                                data_dict.coolingSince = new Date(data_dict.x_data[data_dict.x_data.length-1]);
                            }
                            if ( data.celsius > pivot) {
                                data_dict.timeAbove += (new Date(data.time) - new Date(data_dict.x_data[data_dict.x_data.length-1]));
                                if(isNaN(data_dict.timeAbove)) {
                                    console.log(new Date(data.time));
                                    console.log(data_dict.x_data);
                                    console.log( new Date(data_dict.x_data[data_dict.x_data.length-1]));
                                    fart();
                                }
                            }
                            if ( data.celsius < pivot) {
                                data_dict.timeBelow += (new Date(data.time) - new Date(data_dict.x_data[data_dict.x_data.length-1]));
                            }
                    }
                     data_dict.x_data.push(data.time);
                     data_dict.y_data.push(data.celsius);
                     data_dict.humidity.push(data.humidity);
                     data_dict.dew_point.push(data.dew_point);
                }
            })
            .on("end", function(){
                data_dict.sampleTime = (new Date(data_dict.x_data[data_dict.x_data.length-1]) - new Date(data_dict.x_data[0]));
                console.log('cooling time: ', data_dict.cooling / 60000 + ' minutes');
                console.log('time above ' + pivot + ' degrees: ' +  data_dict.timeAbove / 60000 + ' minutes');
                console.log('time below ' + pivot + ' degrees: ' +  data_dict.timeBelow / 60000 + ' minutes');
                console.log('Sample time: ' + data_dict.sampleTime / 60000 + ' minutes');
                console.log('Percentage cooling:' + (data_dict.cooling / data_dict.sampleTime) * 100);
                graph_data[name] = data_dict;
                doGraph(name, graphDivName, tableDiv);
            });
    }
</script>
  </head>
  <body>
    <div style="position: absolute; left: 10px; right: 10px; top: 10px; bottom: 10px;">
   <div class="row">
      <div class="col s8">
          <div class="valign-wrapper row" id="graph1" style="height: 45vh; margin: 2.5% 0 0 0"></div>
          <div class="valign-wrapper row" id="graph2" style="height: 45vh; margin: 2.5% 0 0 0"></div>
      </div>
      <div class="col s4">
          <div class="valign-wrapper row" id="first" style="height: 45vh; background-color: #ddd; margin: 2.5% 0 0 0"><h5 class="valign center" style="width: 100%">Drag your first data set here</h5></div>
          <div class="valign-wrapper row" id="second" style="height: 45vh; background-color: #ddd;  margin: 2.5% 0 0 0"><h5 class="valign center" style="width: 100%">Drag your second data set here</h5></div>
      </div>
    </div>
</div>

<script>
  var first = document.getElementById('first');
  var second = document.getElementById('second');
  first.ondragover = function () {
    return false;
  };
  first.ondragleave = first.ondragend = function () {
    return false;
  };
  var doGraph = function(name, graphDivName, tableDiv) {
      var data = [{
          x: graph_data[name].x_data,
          y: graph_data[name].y_data,
          name: 'temperature',
      },{
          x: graph_data[name].x_data,
          y: graph_data[name].humidity,
          name: 'humidity',
          yaxis: 'y2',
      }];
      var layout = {
        title: name.split(".")[0],
        yaxis: { title: "Temperature"},      // set the y axis title
        yaxis2: { title: "Humidity",
            overlaying: 'y',
            side: 'right'
        },
        xaxis: {
          showgrid: false,                  // remove the x-axis grid lines
        }
      };
      var d3 = Plotly.d3;
      var gd3 = d3.select("div[id='" + graphDivName + "']");
      var gd = gd3.node();
      Plotly.newPlot(gd, data, layout);
      window.addEventListener('resize', function() { Plotly.Plots.resize(gd); });
      tableDiv.innerHTML = getTable(name);
  }

  first.ondrop = function (e) {
    e.preventDefault();
    var file = e.dataTransfer.files[0];
    processFile(file.path, file.name, 'graph1', first);
    return false;
  };
  second.ondragover = function () {
    return false;
  };
  second.ondragleave = second.ondragend = function () {
  return false;
  };
  second.ondrop = function (e) {
    e.preventDefault();
    var file = e.dataTransfer.files[0];
    processFile(file.path, file.name, 'graph2', second);
    return false;
  };
</script>
  </body>
</html>
